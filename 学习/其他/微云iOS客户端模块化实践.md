# 微云iOS客户端模块化实践
如果把模块化做得够好，我们是否可以像写代码一样简单的构造整个工程呢？比如像下面这样  
```swift
目录模块 = 登录模块 + 目录业务逻辑
照片模块 = 登录模块 + 照片业务逻辑
	.
	.
	.
微云客户端 = 工程配置 + 登录模块 + 设置模块 + 目录模块 + 照片模块 ... + 相册模块
目录子工程 = 工程配置 + 目录模块
```
## 一、什么是模块化？
简单来说，模块化就是将一个程序按照其功能做拆分，分成相互独立的模块，以便于每个模块只包含与其功能相关的内容。模块我们相对熟悉，比如登录功能可以是一个模块，搜索功能可以是一个模块，汽车的发送机也可以是一个模块
## 二、为什么要模块化？
随着产品的迭代，业务越来越复杂，随之带来的是项目结构复杂度的极度增加，此时我们面临着几个问题：
1. 实际业务变化非常快，但是工程之前的业务模块耦合度太高，牵一发而动全身，重构困难
2. 对工程所做的任何修改都必须要编译整个工程（现在有增量编译可能这个问题不是很严重了）
3. 功能测试和系统测试每次都要进行
4. 团队协同开发存在较多的冲突，不得不花费更多的时间去沟通和协调，并且在开发过程中，任何一位成员没办法专注于自己的功能点，影响开发效率
5. 不能灵活的对工程进行配置和组装。比如今天产品经理说加上这个功能，明天又说去掉，后天再加上

## 三、模块化四层定义
为了促进公共组件的生成，这里把整个模块化方案分四层，遵守这样的分层规则可以解决一些依赖问题，让业务模块更容易发展成公共组件，而且子工程也可以直接发布（比如如果智能扫描模块能完全模块化，就可以直接发布一个只有扫描功能的app）
1. 主工程/子工程（尽量简单）
>组合一些业务模块或单个业务模块，可以编译可打包发布
>理想化的工程只是一个壳，几乎不需要实现逻辑
>可以依赖任意模块
2. 业务模块（尽量减少）
>业务模块是实现一些业务需求的相对独立的模块
>不可以循环依赖业务模块，如果暂时无法解藕可以用Linker模块解藕。比如大多数业务模块都会依赖登录模块，那么登录模块就不能依赖几乎所有业务模块
>我们应尽量把业务模块减少，尽可能的提取成基础模块或者公共组件
>比如微云里面的登录模块、任务模块、设置模块、最近模块等等…
3. 基础模块（走在公共组件路上的模块）
>基础模块是一些含有少量业务逻辑，或者完全不含业务逻辑但是还达不到开源标准的模块
比如Scheme、WeiyunSDK、WYKit、LayoutKit等…
这一层的模块已经跟公共组件非常接近了，把接口和文档完善一下就可以做成公共组件，这也是模块化的一大优点
4. 公共组件（我们的目标）
>外部开源组件SwiftLint、CollectionKit、WechatOpenSDK、TencentOpenAPI、LKImageView等…
内部不开源的组件WnsSDK等…

除了工程层，其他层都只能依赖本层模块或更下层的模块，并且本层模块依赖不可以构成环，我们编码过程中尽量把模块下沉，最终可能所有模块都沉淀为公共组件，整个工程都全是公共组件搭建而成

## 四、模块化的优缺点
### 优点
>降低项目复杂性，提升开发效率
解藕复用更简单
可以很方便的重构单一模块
可以提升开发者的接口设计能力和规范开发流程
可以更轻易产出公共组件
### 缺点
>初期解藕比较痛苦
一些流程和工程配置可能会复杂一些
粒度不好把握（推荐按单一职责分）
## 五、微云已提取的模块
1. Login（业务模块，包含子工程，目前只做了解藕还未重构）
>集成微信和QQ登录
包含登录页面以及一些子页面并提供用户信息，可以单独作为子工程运行
依赖WechatOpenSDK、xplatform、WloginSdk、WnsSDK、WeiyunSDK、TencentOpenAPI、LayoutKit、ReachabilitySwift、Linker、Scheme

2. Linker（基础模块，妥协的产物）
>放了一些解藕的方法以及一些公共工具可以暂时放里面
整个工程完全模块化后要想办法把这个模块干掉，它不应该存在
不依赖公共组件以外的任何模块

3. Scheme（基础模块，页面用url跳转，解藕神器）
>目前只提取了微云相关的代码解藕放一起，还未重构
提供VCScheme，专门做VC跳转
依赖Linker

4. Frameworks
>私有pod仓库，放一些不支持pod或支持得不好的公共组件

所有模块和依赖都使用pod管理，并且都做成framework，方便集成和管理。
## 六、微云模块化遇到的一些问题
1. 代码耦合度太高
>问题：可能一个小方法，但是这个小方法会依赖一堆其他代码，其他代码又依赖一些别的代码，没完没了无穷无尽，最终需要把整个项目代码拿过来才行
临时解决方案：专门做了一个Linker基础模块来解藕，后续模块化程度提高过后要想办法把Linker里面的代码都去掉，最好能干掉Linker模块
2. 编译配置问题
>问题：业务模块Login依赖WXApi，WXApi是.a文件。如果LoginManager用Swift写并使用module.modulemap引入WXApi，那么Login.framework导入微云会出现一些链接错误，暂时没找到解决办法
临时解决方案：目前把以前objc写的WYLoginManager拿来继续使用，暂时不重构Login模块

模块化整体框架已经完成并抽离出了一些简单模块，后续会陆续把一些业务逻辑模块化，或者重构+模块化同时进行，提升代码质量并持续下沉模块，争取沉淀出尽量多的公共组件
